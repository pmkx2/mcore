<!DOCTYPE html><html lang="en"><head><title>template</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="template"><meta name="groc-project-path" content="src/template.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/template.coffee</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> date 2016-01-09 16:39:56, author vfasky <a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#x6f;&#58;&#118;&#x66;&#97;&#115;&#x6b;&#121;&#x40;&#103;&#x6d;&#97;&#x69;&#x6c;&#46;&#x63;&#x6f;&#x6d;">&#118;&#x66;&#97;&#115;&#x6b;&#121;&#x40;&#103;&#x6d;&#97;&#x69;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a>, and link <a href="http://vfasky.com">http://vfasky.com</a></span></p>
<h1 id="-virtual-dom-">基于 virtual dom 的模板引擎</h1></div></div><div class="code"><div class="wrapper"><span class="hljs-string">'use strict'</span>

EventEmitter = <span class="hljs-built_in">require</span> <span class="hljs-string">'./eventEmitter'</span>

{
    extend, nextTick, each, isFunction, isArray,
    objectKeys, addEvent, removeEvent, nodeContains
} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./util'</span>

diff = <span class="hljs-built_in">require</span> <span class="hljs-string">'./diff'</span>
patch = <span class="hljs-built_in">require</span> <span class="hljs-string">'./patch'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="demo">demo</h2>
<pre><code class="lang-coffee">{Template} = <span class="hljs-built_in">require</span> <span class="hljs-string">'mcore'</span>
tpl = <span class="hljs-keyword">new</span> Template()


tpl.showIx = <span class="hljs-function"><span class="hljs-params">(event, el, v, k)</span>-&gt;</span>
    <span class="hljs-built_in">console</span>.log v, k

tpl.render <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tpl/test.html'</span>),
    <span class="hljs-attribute">list</span>: [
       {name : <span class="hljs-string">'ok1'</span>}
       {name : <span class="hljs-string">'ok2'</span>}
    ]
, <span class="hljs-function">-&gt;</span> <span class="hljs-comment"># rendered</span>
    <span class="hljs-built_in">document</span>.body.appendChild tpl.refs</code></pre>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- ./tpl/test.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">li</span> <span class="hljs-attribute">mc-for</span>=<span class="hljs-value">"v , k in scope.list"</span> <span class="hljs-attribute">mc-on-click</span>=<span class="hljs-value">"showIx(v, k)"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">mc-data-ix</span>=<span class="hljs-value">"k + 1"</span>&gt;</span>{v.name}<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span></code></pre>
<blockquote>
<p><strong>注：模板事件回调至少传入二个参数</strong></p>
<ul>
<li>第一个参数：event</li>
<li>第二个参数：DOM</li>
<li>... 模板中定义的参数，如：
<code>mc-on-click=&quot;showIx(v, k)&quot;</code> 中接收 v, k
需要这样 <code>tpl.showIx = (event, el, v, k)-&gt;</code></li>
</ul>
<p><em>如果事件不需要传参，侧不需要 <code>()</code>, 否则 h2svd-loader 编绎时，会报错</em></p>
</blockquote></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>模板状态值:</p>
<ul>
<li>0 : 未加载 virtual dom</li>
<li>1 : 已加载 virtual dom ，未渲染</li>
<li>2 : 已加入渲染队列</li>
<li>3 : 渲染完成</li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="hljs-property">@_status</span> = <span class="hljs-number">0</span>

        <span class="hljs-comment">## 渲染队列id</span>
        <span class="hljs-property">@_queueId</span> = <span class="hljs-literal">null</span>

        <span class="hljs-comment">## 初始化 @refs 后，执行的队列</span>
        <span class="hljs-property">@_initTask</span> = []

        <span class="hljs-comment">## 事件上下文</span>
        <span class="hljs-property">@_events</span> = {}

        <span class="hljs-comment">## 已经注册的事件名称</span>
        <span class="hljs-property">@_eventReged</span> = []

        <span class="hljs-comment">## 已经注册的事件</span>
        <span class="hljs-property">@_eventListener</span> = {}

        <span class="hljs-comment">## 真实 dom 的引用</span>
        <span class="hljs-property">@refs</span> = <span class="hljs-literal">null</span>

        <span class="hljs-comment">## virtual dom 定义</span>
        <span class="hljs-property">@virtualDomDefine</span> = <span class="hljs-literal">null</span>

        <span class="hljs-comment">## virtual dom</span>
        <span class="hljs-property">@virtualDom</span> = <span class="hljs-literal">null</span>

        <span class="hljs-comment">## 必须是可被序列化成JSON的值</span>
        <span class="hljs-property">@scope</span> = {}

        <span class="hljs-property">@init</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-scope-">更新 <code>scope</code> 值</h2>
<pre><code class="lang-coffee"><span class="hljs-comment">#清空 `scope.list`</span>
tpl.set <span class="hljs-string">'list'</span>, []</code></pre>
<p><strong>注意!</strong></p>
<p><code>key</code> 只能是 scope 的属性，不能更新子属性
如: <code>tpl.set &#39;list[0].name&#39;, &#39;test&#39;</code> 是不正确的</p>
<p>正确的做法是:</p>
<pre><code class="lang-coffee">list = tpl.get <span class="hljs-string">'list'</span>
list[<span class="hljs-number">0</span>].name = <span class="hljs-string">'test'</span>
tpl.set <span class="hljs-string">'list'</span>, list</code></pre>
<p>你可以不停地更改 scope 的值，而不用担心性能问题，
因为 scope 的更改，会放入队列中，放到浏览器的 nextTick 中渲染。
换言之，你更改N次 scope , 模板引擎只更新一次 DOM</p>
<p>如果你需要在值应用到DOM后，执行回调，可以传入第三个参数</p>
<pre><code class="lang-coffee">tpl.set <span class="hljs-string">'list'</span>, list, <span class="hljs-function">-&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'dom change'</span></code></pre>
<p>你也可以强制模板引擎马上渲染DOM,而不是放入队列(当然，不推荐这样做，因为会阻塞后面的代码)</p>
<pre><code class="lang-coffee">tpl.set <span class="hljs-string">'list'</span>, list, <span class="hljs-literal">true</span>
<span class="hljs-built_in">console</span>.log <span class="hljs-string">'dom change'</span></code></pre></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(key, value, doneOrAsync = <span class="hljs-literal">null</span>)</span>-&gt;</span>
        <span class="hljs-property">@scope</span>[key] = value
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_status</span> == <span class="hljs-number">0</span>

        <span class="hljs-property">@emit</span> <span class="hljs-string">'changeScope'</span>, <span class="hljs-property">@scope</span>, key, value
        <span class="hljs-property">@emit</span> <span class="hljs-string">'change:'</span> + key, value
        <span class="hljs-property">@renderQueue</span> doneOrAsync</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-scope--key">删除 scope 的 key</h2>
<pre><code class="lang-coffee">list = tpl.remove <span class="hljs-string">'list'</span></code></pre>
<blockquote>
<p>同样，第二个参数，可以是回调或者强制马上渲染</p>
</blockquote></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">remove</span>: <span class="hljs-function"><span class="hljs-params">(key, doneOrAsync = <span class="hljs-literal">null</span>)</span>-&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == <span class="hljs-property">@scope</span>.hasOwnProperty(key)
            <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">delete</span> <span class="hljs-property">@scope</span>[key]
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_status</span> == <span class="hljs-number">0</span>

        <span class="hljs-property">@emit</span> <span class="hljs-string">'removeScope'</span>, <span class="hljs-property">@scope</span>, key
        <span class="hljs-property">@emit</span> <span class="hljs-string">'change:'</span> + key, <span class="hljs-literal">null</span>
        <span class="hljs-property">@renderQueue</span> doneOrAsync</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">取值</h2>
<pre><code class="lang-coffee">list = tpl.get <span class="hljs-string">'list'</span></code></pre></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">get</span>: <span class="hljs-function"><span class="hljs-params">(key, defaultVal = <span class="hljs-literal">null</span>)</span>-&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@scope</span>.hasOwnProperty(key)
            <span class="hljs-keyword">return</span> <span class="hljs-property">@scope</span>[key]
        <span class="hljs-keyword">return</span> defaultVal</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">销毁实例</h2>
<p>已经插入 DOM Tree 的，会被移除</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">destroy</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@refs</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@refs</span>.parentNode <span class="hljs-keyword">and</span> <span class="hljs-property">@refs</span>.parentNode.removeChild
            <span class="hljs-property">@refs</span>.parentNode.removeChild <span class="hljs-property">@refs</span>

        <span class="hljs-property">@virtualDomDefine</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@virtualDom</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@scope</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@refs</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@_events</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@_initTask</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@_eventReged</span> = <span class="hljs-literal">null</span>
        <span class="hljs-property">@_eventListener</span> = <span class="hljs-literal">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="--extnds-">预留接口 , extnds 时，直接重写</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="hljs-attribute">init</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">渲染</h2>
<ul>
<li>{Function} virtualDomDefine 用于生成 virtual dom 的函数</li>
<li>{Object} scope</li>
<li>{Null | Function | Boolean} doneOrAsync 渲染成功时回调或者马上渲染，不放入队列</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@virtualDomDefine</span>, scope = {}, doneOrAsync = -&gt;)</span>-&gt;</span>
        <span class="hljs-property">@_status</span> = <span class="hljs-number">1</span>
        <span class="hljs-property">@emit</span> <span class="hljs-string">'beforeRender'</span>

        scopeKeys = objectKeys scope
        scopeLen = scopeKeys.length

        <span class="hljs-keyword">if</span> scopeLen == <span class="hljs-number">0</span>
            <span class="hljs-property">@renderQueue</span> doneOrAsync
        <span class="hljs-keyword">else</span>
            ix = scopeLen - <span class="hljs-number">1</span>
            each scopeKeys, <span class="hljs-function"><span class="hljs-params">(v, k)</span>=&gt;</span>
                <span class="hljs-property">@set</span> v, scope[v], k == ix <span class="hljs-keyword">and</span> doneOrAsync <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">this</span>


    <span class="hljs-comment">## 渲染操作</span>
    <span class="hljs-attribute">_render</span>: <span class="hljs-function"><span class="hljs-params">(done)</span>-&gt;</span>
        scope = extend <span class="hljs-literal">true</span>, <span class="hljs-property">@scope</span>

        {virtualDom} = <span class="hljs-property">@virtualDomDefine</span> scope, @
        <span class="hljs-comment">## 未渲染，不用对比</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@virtualDom</span> == <span class="hljs-literal">null</span>
            <span class="hljs-property">@virtualDom</span> = virtualDom
            <span class="hljs-property">@refs</span> = <span class="hljs-property">@virtualDom</span>.render()

            each <span class="hljs-property">@_initTask</span>, <span class="hljs-function"><span class="hljs-params">(task)</span>-&gt;</span> task()
            <span class="hljs-property">@_initTask</span> = []
        <span class="hljs-keyword">else</span>
            <span class="hljs-comment">## 对比</span>
            patches = diff <span class="hljs-property">@virtualDom</span>, virtualDom
            <span class="hljs-property">@virtualDom</span> = virtualDom

            <span class="hljs-comment">## 更新dom</span>
            patch <span class="hljs-property">@refs</span>, patches

        <span class="hljs-property">@_status</span> = <span class="hljs-number">2</span>
        <span class="hljs-property">@emit</span> <span class="hljs-string">'rendered'</span>, <span class="hljs-property">@refs</span>
        done <span class="hljs-property">@refs</span> <span class="hljs-keyword">if</span> isFunction done


    <span class="hljs-comment">## 渲染队列</span>
    <span class="hljs-attribute">renderQueue</span>: <span class="hljs-function"><span class="hljs-params">(doneOrAsync)</span>-&gt;</span>
        nextTick.clear <span class="hljs-property">@_queueId</span>

        <span class="hljs-comment">## 马上渲染，不进队列</span>
        <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> == doneOrAsync
            <span class="hljs-property">@_render</span>()
        <span class="hljs-keyword">else</span>
            <span class="hljs-property">@_status</span> = <span class="hljs-number">1</span>
            <span class="hljs-property">@_queueId</span> = nextTick =&gt;
                <span class="hljs-property">@_render</span> doneOrAsync


    <span class="hljs-comment">## 注册事件</span>
    <span class="hljs-attribute">addEvent</span>: <span class="hljs-function"><span class="hljs-params">(event, el, callback, id)</span>-&gt;</span>
        event = event.toLowerCase()

        <span class="hljs-property">@_events</span>[event] <span class="hljs-keyword">or</span>= []
        isIn = <span class="hljs-literal">false</span>
        each <span class="hljs-property">@_events</span>[event], <span class="hljs-function"><span class="hljs-params">(e)</span>-&gt;</span>
            <span class="hljs-keyword">if</span> e.id == id
                isIn = <span class="hljs-literal">true</span>
                e.callback = callback
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == isIn
            <span class="hljs-property">@_events</span>[event].push
                <span class="hljs-attribute">el</span>: el
                <span class="hljs-attribute">callback</span>: callback
                <span class="hljs-attribute">id</span>: id

        <span class="hljs-property">@addEventListener</span> event

    <span class="hljs-comment">## 移除事件</span>
    <span class="hljs-attribute">removeEvent</span>: <span class="hljs-function"><span class="hljs-params">(event, el, id)</span>-&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@refs</span>

        event = event.toLowerCase()
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == <span class="hljs-property">@_events</span>.hasOwnProperty(event)

        each <span class="hljs-property">@_events</span>[event], <span class="hljs-function"><span class="hljs-params">(e, i)</span>=&gt;</span>
            <span class="hljs-keyword">if</span> e.id == id
                <span class="hljs-property">@_events</span>[event].splice i, <span class="hljs-number">1</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

        <span class="hljs-comment">## 移除事件</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@_events</span>[event].length == <span class="hljs-number">0</span>
            removeEvent <span class="hljs-property">@refs</span>, event, <span class="hljs-property">@_eventListener</span>[event]

    <span class="hljs-comment">## 注册事件回调</span>
    <span class="hljs-attribute">regEventCallback</span>: <span class="hljs-function"><span class="hljs-params">(event)</span>-&gt;</span>
        <span class="hljs-property">@_eventReged</span>.push event
        <span class="hljs-property">@_eventListener</span>[event] = <span class="hljs-function"><span class="hljs-params">(e)</span>=&gt;</span>
            tasks = <span class="hljs-property">@_events</span>[event]
            each tasks, <span class="hljs-function"><span class="hljs-params">(task)</span>=&gt;</span>
                <span class="hljs-keyword">if</span> task.el == e.target <span class="hljs-keyword">or</span> nodeContains task.el, e.target
                    res = <span class="hljs-literal">null</span>
                    args = [e, task.el]
                    callbackName = task.callback

                    <span class="hljs-keyword">if</span> isArray task.callback
                        _args = task.callback
                        callbackName = _args[<span class="hljs-number">0</span>]

                        each _args, <span class="hljs-function"><span class="hljs-params">(arg, k)</span>-&gt;</span>
                            args.push arg <span class="hljs-keyword">if</span> k &gt; <span class="hljs-number">0</span>

                    <span class="hljs-keyword">if</span> <span class="hljs-property">@_proxy</span> <span class="hljs-keyword">and</span> isFunction <span class="hljs-property">@_proxy</span>[callbackName]
                        res = <span class="hljs-property">@_proxy</span>[callbackName].apply <span class="hljs-property">@_proxy</span>, args

                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isFunction callbackName
                        res = callbackName.apply @, args

                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isFunction @[callbackName]
                        res = @[callbackName].apply @, args

                    <span class="hljs-keyword">else</span>
                        <span class="hljs-built_in">console</span>.log task.callback
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'not callback : '</span> + task.callback

                    <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == res
                        <span class="hljs-keyword">if</span> e.stopPropagation <span class="hljs-keyword">and</span> e.preventDefault
                            e.stopPropagation()
                            e.preventDefault()
                        <span class="hljs-keyword">else</span>
                            <span class="hljs-built_in">window</span>.event.cancelBubble = <span class="hljs-literal">true</span>
                            <span class="hljs-built_in">window</span>.event.returnValue = <span class="hljs-literal">false</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>


    <span class="hljs-comment">## 注册事件</span>
    <span class="hljs-attribute">addEventListener</span>: <span class="hljs-function"><span class="hljs-params">(event)</span>-&gt;</span>
        <span class="hljs-keyword">if</span> !<span class="hljs-property">@refs</span>
            <span class="hljs-property">@_initTask</span>.push =&gt; <span class="hljs-property">@addEventListener</span> event
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> event <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@_eventReged</span>
            <span class="hljs-property">@regEventCallback</span> event
            addEvent <span class="hljs-property">@refs</span>, event, <span class="hljs-property">@_eventListener</span>[event]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">过滤函数</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">Template.formatters = <span class="hljs-built_in">require</span> <span class="hljs-string">'./formatters'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">组件</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">Template.components = {}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">属性</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">Template.binders = <span class="hljs-built_in">require</span> <span class="hljs-string">'./binders'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-dom--string--template--function">用于从 DOM 的 String 属性取得对应 Template 的 Function</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">Template.strToFun = <span class="hljs-function"><span class="hljs-params">(el, funName)</span>-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> !el._element

    proxyFun = <span class="hljs-literal">null</span>
    proxyEnv = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span> el._element.template.hasOwnProperty(<span class="hljs-string">'_proxy'</span>) <span class="hljs-keyword">and</span> el._element.template._proxy[funName]
        proxyEnv = el._element.template._proxy
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> el._element.template[funName]
        proxyEnv = el._element.template

    <span class="hljs-keyword">if</span> proxyEnv
        proxyFun = proxyEnv[funName]
<span class="hljs-function">        <span class="hljs-title">callback</span> = -&gt;</span>
            proxyFun.apply proxyEnv, arguments

        <span class="hljs-keyword">return</span> callback

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>


<span class="hljs-built_in">module</span>.exports = Template</div></div></div></div></body></html>