<!DOCTYPE html><html lang="en"><head><title>diff</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="diff"><meta name="groc-project-path" content="src/diff.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/diff.coffee</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> date 2016-01-21 19:36:17</span></p>
<p>修改自 simple-virtual-dom</p></div></div><div class="code"><div class="wrapper"><span class="hljs-string">'use strict'</span>

patch = <span class="hljs-built_in">require</span> <span class="hljs-string">'./patch'</span>

listDiff = <span class="hljs-built_in">require</span> <span class="hljs-string">'list-diff2'</span>

{isString, each} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./util'</span>
<span class="hljs-function">
<span class="hljs-title">diff</span> = <span class="hljs-params">(oldTree, newTree)</span> -&gt;</span>
    index = <span class="hljs-number">0</span>
    patches = {}
    <span class="hljs-comment">#console.log oldTree, newTree</span>
    dfsWalk oldTree, newTree, index, patches
    patches
<span class="hljs-function">
<span class="hljs-title">dfsWalk</span> = <span class="hljs-params">(oldNode, newNode, index, patches)</span> -&gt;</span>
    <span class="hljs-comment">#if oldNode._component</span>
    <span class="hljs-comment">#console.log oldNode, newNode</span>
    currentPatch = []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>node is removed</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> newNode == <span class="hljs-literal">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>will be removed when perform reordering, so has no needs to do anthings in here
textNode content replacing</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isString(oldNode) <span class="hljs-keyword">and</span> isString(newNode)
        <span class="hljs-keyword">if</span> newNode != oldNode
            currentPatch.push
                <span class="hljs-attribute">type</span>: patch.TEXT
                <span class="hljs-attribute">content</span>: newNode</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>nodes are the same, diff its props and children</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> oldNode.tagName == newNode.tagName <span class="hljs-keyword">and</span> oldNode.key == newNode.key</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if oldNode._component</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-comment">#console.log oldNode.props</span>
        <span class="hljs-keyword">if</span> oldNode._element
            newNode._element = oldNode._element
        <span class="hljs-keyword">if</span> oldNode._component
            newNode._component = oldNode._component</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>diff props</p></div></div><div class="code"><div class="wrapper">        propsPatches = diffProps(oldNode, newNode)
        
        <span class="hljs-keyword">if</span> propsPatches
            currentPatch.push
                <span class="hljs-attribute">type</span>: patch.PROPS
                <span class="hljs-attribute">props</span>: propsPatches
            
        <span class="hljs-keyword">if</span> !oldNode._component</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>diff children</p></div></div><div class="code"><div class="wrapper">            diffChildren oldNode.children, newNode.children, index, patches, currentPatch</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>nodes are not the same, replace the old node with new node</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">else</span>
        currentPatch.push
            <span class="hljs-attribute">type</span>: patch.REPLACE
            <span class="hljs-attribute">node</span>: newNode
    <span class="hljs-keyword">if</span> currentPatch.length
        patches[index] = currentPatch
    <span class="hljs-keyword">return</span>
<span class="hljs-function">

<span class="hljs-title">diffChildren</span> = <span class="hljs-params">(oldChildren, newChildren, index, patches, currentPatch)</span> -&gt;</span>
    diffs = listDiff(oldChildren, newChildren, <span class="hljs-string">'key'</span>)
    newChildren = diffs.children
    <span class="hljs-keyword">if</span> diffs.moves.length
        reorderPatch =
            <span class="hljs-attribute">type</span>: patch.REORDER
            <span class="hljs-attribute">moves</span>: diffs.moves
        currentPatch.push reorderPatch
    leftNode = <span class="hljs-literal">null</span>
    currentNodeIndex = index

    each oldChildren, <span class="hljs-function"><span class="hljs-params">(child, i)</span> -&gt;</span>
        newChild = newChildren[i]
        currentNodeIndex = <span class="hljs-keyword">if</span> leftNode <span class="hljs-keyword">and</span> leftNode.count <span class="hljs-keyword">then</span> currentNodeIndex + leftNode.count + <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> currentNodeIndex + <span class="hljs-number">1</span>
        dfsWalk child, newChild, currentNodeIndex, patches
        leftNode = child
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">return</span>
<span class="hljs-function">

<span class="hljs-title">diffProps</span> = <span class="hljs-params">(oldNode, newNode)</span> -&gt;</span>
    count = <span class="hljs-number">0</span>
    oldProps = oldNode.props
    newProps = newNode.props
    propsPatches = {}

    <span class="hljs-comment">#if oldNode._component</span>
        <span class="hljs-comment">#console.log oldNode.props</span>

    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> oldProps
        <span class="hljs-keyword">if</span> newProps[key] != value
            count++
            propsPatches[key] = newProps[key]
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>find out new property</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> newProps
        <span class="hljs-keyword">if</span> !oldProps.hasOwnProperty(key)
            count++
            propsPatches[key] = newProps[key]

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span>

    
    propsPatches


<span class="hljs-built_in">module</span>.exports = diff</div></div></div></div></body></html>