<!DOCTYPE html><html lang="en"><head><title>patch</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="patch"><meta name="groc-project-path" content="src/patch.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/patch.coffee</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> date 2016-01-21 19:39:03</span></p>
<p>修改自 simple-virtual-dom</p></div></div><div class="code"><div class="wrapper"><span class="hljs-string">'use strict'</span>

REPLACE = <span class="hljs-number">0</span>
REORDER = <span class="hljs-number">1</span>
PROPS = <span class="hljs-number">2</span>
TEXT = <span class="hljs-number">3</span>

{setElementAttr, removeElementAttr, toArray, each} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./util'</span>
<span class="hljs-function">
<span class="hljs-title">patch</span> = <span class="hljs-params">(node, patches)</span> -&gt;</span>
    walker = <span class="hljs-attribute">index</span>: <span class="hljs-number">0</span>
    dfsWalk node, walker, patches
    <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">dfsWalk</span> = <span class="hljs-params">(node, walker, patches)</span> -&gt;</span>
    currentPatches = patches[walker.index]
    <span class="hljs-comment">#console.log node</span>
    len = <span class="hljs-keyword">if</span> node.childNodes <span class="hljs-keyword">then</span> node.childNodes.length <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
    len = <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> node._component
    i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> i &lt; len
        child = node.childNodes[i]
        walker.index++
        dfsWalk child, walker, patches
        i++
    <span class="hljs-keyword">if</span> currentPatches
        applyPatches node, currentPatches
    <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">applyPatches</span> = <span class="hljs-params">(node, currentPatches)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> currentPatch <span class="hljs-keyword">in</span> currentPatches
        <span class="hljs-keyword">switch</span> currentPatch.type
            <span class="hljs-keyword">when</span> REPLACE
              node.parentNode.replaceChild currentPatch.node.render(), node
            <span class="hljs-keyword">when</span> REORDER
                reorderChildren node, currentPatch.moves
            <span class="hljs-keyword">when</span> PROPS
                setProps node, currentPatch.props
            <span class="hljs-keyword">when</span> TEXT
                <span class="hljs-keyword">if</span> node.textContent
                    node.textContent = currentPatch.content
                <span class="hljs-keyword">else</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>fuck ie</p></div></div><div class="code"><div class="wrapper">                    node.nodeValue = currentPatch.content
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'Unknown patch type '</span> + currentPatch.type)
    <span class="hljs-keyword">return</span>
<span class="hljs-function">

<span class="hljs-title">setProps</span> = <span class="hljs-params">(node, props)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> props
        <span class="hljs-keyword">if</span> props[key] == <span class="hljs-literal">undefined</span>
            removeElementAttr node, key <span class="hljs-keyword">if</span> key != <span class="hljs-string">'_mc'</span>
        <span class="hljs-keyword">else</span>
            value = props[key]
            setElementAttr node, key, value
<span class="hljs-function">

<span class="hljs-title">reorderChildren</span> = <span class="hljs-params">(node, moves)</span> -&gt;</span>
    staticNodeList = toArray node.childNodes
    maps = {}
    each staticNodeList, <span class="hljs-function"><span class="hljs-params">(node)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> node.nodeType == <span class="hljs-number">1</span>
            key = node.getAttribute(<span class="hljs-string">'key'</span>)
        <span class="hljs-keyword">if</span> key
            maps[key] = node
        <span class="hljs-keyword">return</span>

    each moves, <span class="hljs-function"><span class="hljs-params">(move)</span> -&gt;</span>
        index = move.index
        <span class="hljs-keyword">if</span> move.type == <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>remove item</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">if</span> staticNodeList[index] == node.childNodes[index]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>maybe have been removed for inserting</p></div></div><div class="code"><div class="wrapper">                el = node.childNodes[index]
                el._element.destroy() <span class="hljs-keyword">if</span> el._element <span class="hljs-keyword">and</span> el._element.destroy
                node.removeChild el
            staticNodeList.splice index, <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> move.type == <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>insert item</p></div></div><div class="code"><div class="wrapper">            insertNode = <span class="hljs-keyword">if</span> maps[move.item.key] <span class="hljs-keyword">then</span> maps[move.item.key] <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> move.item == <span class="hljs-string">'object'</span> <span class="hljs-keyword">then</span> move.item.render() <span class="hljs-keyword">else</span> <span class="hljs-built_in">document</span>.createTextNode(move.item)
            staticNodeList.splice index, <span class="hljs-number">0</span>, insertNode
            node.insertBefore insertNode, node.childNodes[index] <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">return</span>

patch.REPLACE = REPLACE
patch.REORDER = REORDER
patch.PROPS = PROPS
patch.TEXT = TEXT
<span class="hljs-built_in">module</span>.exports = patch</div></div></div></div></body></html>