<!DOCTYPE html><html lang="en"><head><title>element</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="element"><meta name="groc-project-path" content="src/element.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/element.coffee</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> date 2016-01-21 19:34:48</span></p>
<p>修改自 simple-virtual-dom </p></div></div><div class="code"><div class="wrapper"><span class="hljs-string">'use strict'</span>

_id = <span class="hljs-number">0</span>

Template = <span class="hljs-built_in">require</span> <span class="hljs-string">'./template'</span>
{setElementAttr, each, isFunction} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./util'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Element</span></span>
    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(tagName, <span class="hljs-property">@props</span> = {}, <span class="hljs-property">@children</span> = [])</span>-&gt;</span>
        <span class="hljs-property">@tagName</span> = tagName.toLowerCase()

        <span class="hljs-property">@_id</span> = _id++</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>自定义属性绑定</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-property">@_binders</span> = []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>已经初始化的属性</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-property">@_bindersReg</span> = []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>自定义组件</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-property">@_component</span> = <span class="hljs-literal">null</span>

        <span class="hljs-property">@key</span> = <span class="hljs-property">@props</span>.key <span class="hljs-keyword">or</span> <span class="hljs-literal">undefined</span>

        count = <span class="hljs-number">0</span>

        each <span class="hljs-property">@children</span>, <span class="hljs-function"><span class="hljs-params">(child, i)</span>=&gt;</span>
            <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> Element
                count += child.count
            <span class="hljs-keyword">else</span>
                <span class="hljs-property">@children</span>[i] = String child

            count++

        <span class="hljs-property">@count</span> = count

    <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
        el = <span class="hljs-property">@bindComponent</span>()

        <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == el
            el = <span class="hljs-built_in">document</span>.createElement <span class="hljs-property">@tagName</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>已经绑定模板引擎</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">if</span> <span class="hljs-property">@template</span>
                el._element = @
                <span class="hljs-property">@el</span> = el
                
            <span class="hljs-keyword">for</span> attr, value <span class="hljs-keyword">of</span> <span class="hljs-property">@props</span>
                <span class="hljs-property">@setAttribute</span> el, attr, value</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>渲染子元素</p></div></div><div class="code"><div class="wrapper">            each <span class="hljs-property">@children</span>, <span class="hljs-function"><span class="hljs-params">(child)</span>-&gt;</span>
                <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> Element
                    childEl = child.render()
                <span class="hljs-keyword">else</span>
                    childEl = <span class="hljs-built_in">document</span>.createTextNode child

                el.appendChild childEl

            <span class="hljs-keyword">for</span> binder <span class="hljs-keyword">in</span> <span class="hljs-property">@_binders</span>
                binder.binder.rendered.call @, el, binder.value <span class="hljs-keyword">if</span> binder.binder.rendered

        el</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>移除属性</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">removeAttribute</span>: <span class="hljs-function"><span class="hljs-params">(attrName)</span>-&gt;</span>
        attrName = attrName.toLowerCase()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>通知组件更新</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> <span class="hljs-property">@_component</span>
            <span class="hljs-property">@_component</span>.update attrName, <span class="hljs-literal">null</span>

        <span class="hljs-keyword">for</span> binder <span class="hljs-keyword">in</span> <span class="hljs-property">@_binders</span>
            <span class="hljs-keyword">if</span> binder.attrName == attrName
                binder.binder.remove.call @, <span class="hljs-property">@el</span> <span class="hljs-keyword">if</span> binder.binder.remove
                binder.value = <span class="hljs-literal">null</span>
                <span class="hljs-keyword">return</span>

        <span class="hljs-property">@el</span>.removeAttribute attrName

    
    <span class="hljs-attribute">destroy</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> !<span class="hljs-property">@template</span>

        <span class="hljs-keyword">if</span> <span class="hljs-property">@_component</span>
            <span class="hljs-property">@_component</span>.destroy()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>移除事件</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">for</span> attrName <span class="hljs-keyword">of</span> <span class="hljs-property">@props</span>
            <span class="hljs-keyword">if</span> attrName.indexOf(<span class="hljs-string">'on-'</span>) == <span class="hljs-number">0</span>
                event = attrName.replace(<span class="hljs-string">'on-'</span>, <span class="hljs-string">''</span>)
                <span class="hljs-property">@template</span>.removeEvent event, <span class="hljs-property">@el</span>, <span class="hljs-property">@_id</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>设置属性值</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">setAttribute</span>: <span class="hljs-function"><span class="hljs-params">(el, attrName, value)</span>-&gt;</span>
        
        attrName = String(attrName).toLowerCase()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>通知组件更新</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> <span class="hljs-property">@_component</span>
            <span class="hljs-property">@_component</span>.update attrName, value</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>已经绑定模板引擎</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> <span class="hljs-property">@template</span>
            </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>事件注册</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">if</span> attrName.indexOf(<span class="hljs-string">'on-'</span>) == <span class="hljs-number">0</span>
                <span class="hljs-property">@template</span>.addEvent attrName.replace(<span class="hljs-string">'on-'</span>, <span class="hljs-string">''</span>), el, value, <span class="hljs-property">@_id</span>
                <span class="hljs-comment">#setElementAttr el, '_mc', @_id, true</span>
                <span class="hljs-keyword">return</span>


            <span class="hljs-keyword">for</span> binder <span class="hljs-keyword">in</span> <span class="hljs-property">@_binders</span>
                <span class="hljs-keyword">if</span> binder.attrName == attrName</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>init</p></div></div><div class="code"><div class="wrapper">                    <span class="hljs-keyword">if</span> attrName <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-property">@_bindersReg</span>
                        <span class="hljs-property">@_bindersReg</span>.push attrName
                        binder.binder.init.call @, el <span class="hljs-keyword">if</span> binder.binder.init

                    <span class="hljs-comment">#return if binder.value == value</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>update</p></div></div><div class="code"><div class="wrapper">                    <span class="hljs-keyword">if</span> binder.binder.update
                        binder.binder.update.call @, el, value
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isFunction(binder.binder)
                        binder.binder.call @, el, value

                    binder.value = value
                        
                    <span class="hljs-keyword">return</span>

        setElementAttr el, attrName, value, <span class="hljs-literal">true</span>

        </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>绑定自定义组件</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">bindComponent</span>: <span class="hljs-function">-&gt;</span>

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span> == Template.components.hasOwnProperty <span class="hljs-property">@tagName</span>

        el = <span class="hljs-built_in">document</span>.createElement <span class="hljs-property">@tagName</span>
        <span class="hljs-property">@_component</span> = <span class="hljs-keyword">new</span> Template.components[<span class="hljs-property">@tagName</span>] el, @

        <span class="hljs-keyword">for</span> attr, value <span class="hljs-keyword">of</span> <span class="hljs-property">@props</span>
            <span class="hljs-property">@setAttribute</span> el, attr, value

        el._element = @
        el._component = <span class="hljs-property">@_component</span>
        el</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>绑定自定义属性</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-attribute">bindBinder</span>: <span class="hljs-function"><span class="hljs-params">(attrName, value)</span>-&gt;</span>
        <span class="hljs-keyword">if</span> Template.binders.hasOwnProperty attrName
            <span class="hljs-property">@_binders</span>.push
                <span class="hljs-attribute">binder</span>: Template.binders[attrName]
                <span class="hljs-attribute">value</span>: value
                <span class="hljs-attribute">attrName</span>: attrName.toLowerCase()

    <span class="hljs-attribute">bindTemplate</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@template</span>)</span>-&gt;</span>

<span class="hljs-built_in">module</span>.exports = Element</div></div></div></div></body></html>