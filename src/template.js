// Generated by CoffeeScript 1.10.0

/**
 * 基于 virtual dom 的模板引擎
 * @date 2016-01-09 16:39:56
 * @author vfasky <vfasky@gmail.com>
 * @link http://vfasky.com
 */
'use strict';
var EventEmitter, Template, clone, diff, each, isFunction, nextTick, patch, ref, util,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

EventEmitter = require('./eventEmitter');

util = require('./util');

ref = require('./util'), clone = ref.clone, nextTick = ref.nextTick, each = ref.each, isFunction = ref.isFunction;

diff = require('./diff');

patch = require('./patch');

Template = (function(superClass) {
  extend(Template, superClass);

  function Template() {
    this._status = 0;
    this._queueId = null;
    this._initTask = [];
    this._events = {};
    this._eventReged = [];
    this.refs = null;
    this.virtualDomDefine = null;
    this.virtualDom = null;
    this.scope = {};
    this.init();
  }

  Template.prototype.test = function() {
    return alert('hello');
  };

  Template.prototype.watchScope = function() {
    if (this.__initWatch) {
      return;
    }
    return this.__initWatch = true;
  };

  Template.prototype.set = function(key, value, doneOrAsync) {
    if (doneOrAsync == null) {
      doneOrAsync = null;
    }
    this.scope[key] = value;
    if (this._status === 0) {
      return;
    }
    this.emit('changeScope', this.scope, key, value);
    return this.renderQueue(doneOrAsync);
  };

  Template.prototype.get = function(key, defaultVal) {
    if (defaultVal == null) {
      defaultVal = null;
    }
    if (this.scope.hasOwnProperty(key)) {
      return this.scope[key];
    }
    return defaultVal;
  };

  Template.prototype.destroy = function() {
    if (this.__initWatch) {
      Object.unobserve(this.scope);
    }
    if (this.refs && this.refs.parentNode && this.refs.parentNode.removeChild) {
      return this.refs.parentNode.removeChild(this.refs);
    }
  };

  Template.prototype.init = function() {};

  Template.prototype._render = function(done) {
    var patches, scope, virtualDom;
    scope = util.extend(true, this.scope);
    virtualDom = this.virtualDomDefine(scope, this).virtualDom;
    if (this.virtualDom === null) {
      this.virtualDom = virtualDom;
      this.refs = this.virtualDom.render();
      each(this._initTask, function(task) {
        return task();
      });
      this._initTask = [];
    } else {
      patches = diff(this.virtualDom, virtualDom);
      this.virtualDom = virtualDom;
      patch(this.refs, patches);
    }
    this._status = 2;
    this.emit('rendered');
    if (util.isFunction(done)) {
      return done();
    }
  };

  Template.prototype.renderQueue = function(doneOrAsync) {
    nextTick.clear(this._queueId);
    if (true === doneOrAsync) {
      return this._render();
    } else {
      this._status = 1;
      return this._queueId = nextTick((function(_this) {
        return function() {
          return _this._render(doneOrAsync);
        };
      })(this));
    }
  };

  Template.prototype.regEvent = function(event, el, callback, id) {
    var base, isIn;
    event = event.toLowerCase();
    (base = this._events)[event] || (base[event] = []);
    isIn = false;
    each(this._events[event], function(e) {
      if (e.id === id) {
        isIn = true;
        e.callback = callback;
        return false;
      }
    });
    if (false === isIn) {
      this._events[event].push({
        el: el,
        callback: callback,
        id: id
      });
    }
    return this.addEventListener(event);
  };

  Template.prototype.addEventListener = function(event) {
    if (!this.refs) {
      this._initTask.push((function(_this) {
        return function() {
          return _this.addEventListener(event);
        };
      })(this));
      return;
    }
    if (indexOf.call(this._eventReged, event) < 0) {
      this._eventReged.push(event);
      return this.refs.addEventListener(event, (function(_this) {
        return function(e) {
          var tasks;
          tasks = _this._events[event];
          return each(tasks, function(task) {
            var res;
            if (task.el === e.target) {
              res = null;
              if (isFunction(task.callback)) {
                res = task.callback(task.el, e);
              } else if (isFunction(_this[task.callback])) {
                res = _this[task.callback](task.el, e);
              } else {
                throw new Error('not callback :' + task.callback);
              }
              if (false === res) {
                if (e.stopPropagation && e.preventDefault) {
                  e.stopPropagation();
                  e.preventDefault();
                } else {
                  window.event.cancelBubble = true;
                  window.event.returnValue = false;
                }
              }
              return false;
            }
          });
        };
      })(this));
    }
  };

  Template.prototype.render = function(virtualDomDefine, scope, doneOrAsync) {
    var ix, scopeKeys, scopeLen;
    this.virtualDomDefine = virtualDomDefine;
    if (scope == null) {
      scope = {};
    }
    if (doneOrAsync == null) {
      doneOrAsync = function() {};
    }
    this._status = 1;
    this.emit('beforeRender');
    scopeKeys = Object.keys(scope);
    scopeLen = scopeKeys.length;
    if (scopeLen === 0) {
      this.renderQueue(doneOrAsync);
    } else {
      ix = scopeLen - 1;
      each(scopeKeys, (function(_this) {
        return function(v, k) {
          return _this.set(v, scope[v], k === ix && doneOrAsync || null);
        };
      })(this));
    }
    this.watchScope();
    return this;
  };

  return Template;

})(EventEmitter);

Template.formatters = require('./formatters');

Template.components = {};

Template.binders = require('./binders');

module.exports = Template;
