// Generated by CoffeeScript 1.9.3

/**
 * api
 * @module cnode/api
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode/api', ['jquery'], function($) {
    "use strict";
    var _host, exports;
    _host = 'https://cnodejs.org/api/v1';
    return exports = {
      topics: function(data) {
        if (data == null) {
          data = {};
        }
        data = $.extend({
          mdrender: false,
          limit: 10
        }, data);
        return $.get(_host + '/topics', data);
      },
      topic: function(id) {
        return $.get(_host + '/topic/' + id, {
          mdrender: false
        });
      }
    };
  });

}).call(this);

;
// Generated by CoffeeScript 1.9.3

/**
 * 启动
 * @module cnode/bootstrap
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode', ['jquery', 'mcore', 'tag'], function($, mcore) {
    "use strict";
    var init;
    init = false;
    return function(select, loadSelect) {
      var app;
      app = new mcore.App($(select));
      app.route('/topic/:id', 'cnode/topic').route('*', 'cnode/index');
      app.on('runView', function() {
        if (init === false) {
          init = true;
          return $(loadSelect).remove();
        }
      });
      return app.run();
    };
  });

}).call(this);

;
// Generated by CoffeeScript 1.9.3

/**
 * 过滤函数
 * @module cnode/formatters
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode/formatters', ['mcore', 'moment', 'markdown-it', 'highlight'], function(mcore, moment, Markdownit) {
    "use strict";
    var Template, highlight, markdown;
    hljs.initHighlightingOnLoad();
    Template = mcore.Template;
    highlight = (function() {
      var alias;
      alias = [
        {
          js: 'javascript',
          jscript: 'javascript',
          html: 'xml',
          htm: 'xml',
          coffee: 'coffeescript',
          'coffee-script': 'coffeescript',
          yml: 'yaml',
          pl: 'perl',
          ru: 'ruby',
          rb: 'ruby',
          csharp: 'cs'
        }
      ];
      return function(str, lang) {
        var _, compiled, content, firstLine, lines, numbers, result;
        lang = String(lang).toLowerCase() || 'plain';
        if (alias[lang]) {
          lang = alias[lang];
        }
        if (hljs.getLanguage(lang)) {
          try {
            compiled = hljs.highlight(lang, str).value;
          } catch (_error) {
            _ = _error;
            compiled = hljs.highlightAuto(str).value;
          }
        } else {
          compiled = hljs.highlightAuto(str).value;
        }
        lines = compiled.split('\n');
        numbers = '';
        content = '';
        firstLine = 1;
        if (!lines[lines.length - 1]) {
          lines.pop();
        }
        lines.forEach(function(item, i) {
          numbers += '<div class="line">' + (i + firstLine) + '</div>';
          return content += '<div class="line">' + item + '</div>';
        });
        result = '<figure class="highlight' + (lang != null ? lang : ' ' + {
          lang: ''
        }) + '">';
        result += "<table>\n    <tr>\n        <td class=\"gutter\"><pre>" + numbers + "</pre></td>\n        <td class=\"code\"><pre>" + content + "</pre></td>\n    </tr>\n</table>";
        result += '</figure>';
        return result;
      };
    })();
    markdown = new Markdownit({
      html: false,
      xhtmlOut: false,
      breaks: true,
      langPrefix: 'hljs ',
      linkify: true,
      typographer: false,
      highlight: highlight
    });
    Template.formatters('dateFormat', function(value, format) {
      if (format == null) {
        format = 'YYYY-MM-DD';
      }
      return moment(value).format(format);
    });
    Template.formatters('fromNow', function(value) {
      return moment(value).fromNow();
    });
    return Template.formatters('markdown', function(value) {
      return markdown.render(value);
    });
  });

}).call(this);

;
// Generated by CoffeeScript 1.9.3

/**
 *
 * @module cnode/topic
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode/topic', ['jquery', 'cnode/view', 'mcore-attr/scroller', 'cnode/formatters'], function($, View) {
    "use strict";
    return View.subclass({
      constructor: View.prototype.constructor,
      run: function(id) {
        return this.render('cnode/topic.html', {
          topic: this.api.topic(id)
        });
      }
    });
  });

}).call(this);

;
// Generated by CoffeeScript 1.9.3

/**
 * 
 * @module cnode/view
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode/view', ['jquery', 'mcore', 'cnode/api'], function($, mcore, api) {
    "use strict";
    return mcore.View.subclass({
      constructor: mcore.View.prototype.constructor,
      beforeInit: function() {
        return this.api = api;
      }
    });
  });

}).call(this);

;
// Generated by CoffeeScript 1.9.3

/**
 * 首页
 * @module cnode/index
 * @author vfasky <vfasky@gmail.com>
 */

(function() {
  define('cnode/index', ['jquery', 'cnode/view', 'mcore-attr/scroller', 'cnode/formatters'], function($, View) {
    "use strict";
    return View.subclass({
      constructor: View.prototype.constructor,
      run: function(tab) {
        this.context.page = Number(this.context.page || 1);
        this.context.tab = this.context.tab || '';
        this.nextPage = this.context.page + 1;
        this.prePage = this.context.page - 1;
        this.page = 1;
        return this.render('cnode/index.html', {
          topics: this.getTopics(),
          loadPageDone: true
        });
      },
      getTopics: function() {
        var page, promise, tab;
        page = this.context.page;
        tab = this.context.tab;
        promise = (function(_this) {
          return function() {
            return _this.api.topics({
              page: page,
              tab: tab
            });
          };
        })(this);
        return this.memoryCache("index_topics_" + page + "_" + tab).has(promise);
      }
    });
  });

}).call(this);
